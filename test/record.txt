Run 1
Checking the gradient on Cleint 1
The diff is 1.9882521167457068
Checking the gradient on Cleint 4
The diff is 1.9812846922457577
Checking the gradient on Cleint 5
The diff is 1.9849382514659963

Checking the gradient on Cleint 4
The diff is 1.5849155203737062
Checking the gradient on Cleint 5
The diff is 1.600345838799811
Checking the gradient on Cleint 3
The diff is 1.5948417405469075

Checking the gradient on Cleint 1
The diff is 1.2630340456739606
Checking the gradient on Cleint 3
The diff is 1.2680291812278885
Checking the gradient on Cleint 2
The diff is 1.2625253066640996

Checking the gradient on Cleint 2
The diff is 1.11997761525013
Checking the gradient on Cleint 5
The diff is 1.1216399083263737
Checking the gradient on Cleint 3
The diff is 1.1315345589524597

Run 2

Checking the gradient on Cleint 5
The diff is 1.8836415189009432
Checking the gradient on Cleint 4
The diff is 1.8736127289248061
Checking the gradient on Cleint 1
The diff is 1.8645492003215702

Checking the gradient on Cleint 1
The diff is 1.4594128293361628
Checking the gradient on Cleint 4
The diff is 1.4450231589921203
Checking the gradient on Cleint 2
The diff is 1.4524713788800256

hecking the gradient on Cleint 5
The diff is 1.2500928311094925
Checking the gradient on Cleint 1
The diff is 1.2464611524568874
Checking the gradient on Cleint 2
The diff is 1.2488461031369342

Checking the gradient on Cleint 4
The diff is 1.1900620905368613
Checking the gradient on Cleint 2
The diff is 1.178693559525755
Checking the gradient on Cleint 1
The diff is 1.1852018085726295

Run 3

Checking the gradient on Cleint 5
The diff is 2.040268277197545
Checking the gradient on Cleint 3
The diff is 2.0251185154582316
Checking the gradient on Cleint 1
The diff is 2.0320438115003983

Checking the gradient on Cleint 3
The diff is 1.5252928055875137
Checking the gradient on Cleint 2
The diff is 1.5062915364128695
Checking the gradient on Cleint 5
The diff is 1.5254400560035983

Checking the gradient on Cleint 3
The diff is 1.286209370511777
Checking the gradient on Cleint 4
The diff is 1.3002133104380038
Checking the gradient on Cleint 1
The diff is 1.2959226125227514

Checking the gradient on Cleint 4
The diff is 1.1481475240143528
Checking the gradient on Cleint 1
The diff is 1.138073395420345
Checking the gradient on Cleint 2
The diff is 1.150272472716283

Run

Checking the gradient on Cleint 4
The diff is 1.9314827090777722
Checking the gradient on Cleint 2
The diff is 1.9292915178839676
Checking the gradient on Cleint 3
The diff is 1.9654959200243172

Checking the gradient on Cleint 4
The diff is 1.5401182336908585
Checking the gradient on Cleint 1
The diff is 1.5533944415421355
Checking the gradient on Cleint 2
The diff is 1.5445034263422739

Checking the gradient on Cleint 2
The diff is 1.233056074837621
Checking the gradient on Cleint 3
The diff is 1.2288102079374978
Checking the gradient on Cleint 5
The diff is 1.2358186719815465

Checking the gradient on Cleint 5
The diff is 1.1323852165202821
Checking the gradient on Cleint 4
The diff is 1.1314795945804639
Checking the gradient on Cleint 1
The diff is 1.1305883392663267

Run

Checking the gradient on Cleint 1
The diff is 2.0503199566295716
Checking the gradient on Cleint 4
The diff is 2.0506376586507984
Checking the gradient on Cleint 2
The diff is 2.0195784726478774

Checking the gradient on Cleint 1
The diff is 1.5358961145994157
Checking the gradient on Cleint 3
The diff is 1.5281864594798316
Checking the gradient on Cleint 2
The diff is 1.5411928385020284

Checking the gradient on Cleint 2
The diff is 1.1418700268465667
Checking the gradient on Cleint 1
The diff is 1.1493210254155637
Checking the gradient on Cleint 4
The diff is 1.1347070907884698

Checking the gradient on Cleint 5
The diff is 1.0804365410259764
Checking the gradient on Cleint 3
The diff is 1.0802038773506
Checking the gradient on Cleint 2
The diff is 1.08430767935342

Run

Checking the gradient on Cleint 3
The diff is 2.122421783417527
Checking the gradient on Cleint 5
The diff is 2.1353823813014383
Checking the gradient on Cleint 1
The diff is 2.1129476612085534

Checking the gradient on Cleint 4
The diff is 1.649912886137943
Checking the gradient on Cleint 3
The diff is 1.6404032499777266
Checking the gradient on Cleint 5
The diff is 1.6439185850985245

Checking the gradient on Cleint 5
The diff is 1.2933042689178438
Checking the gradient on Cleint 3
The diff is 1.301701872466684
Checking the gradient on Cleint 4
The diff is 1.3071530357285672

Checking the gradient on Cleint 1
The diff is 1.1513351369882032
Checking the gradient on Cleint 5
The diff is 1.158339071050625
Checking the gradient on Cleint 3
The diff is 1.1452027895307397

Run

Checking the gradient on Cleint 5
The diff is 1.9516245138769388
Checking the gradient on Cleint 3
The diff is 1.9437705991100644
Checking the gradient on Cleint 1
The diff is 1.953736260639423

Checking the gradient on Cleint 1
The diff is 1.4732522923817555
Checking the gradient on Cleint 5
The diff is 1.4698978526283468
Checking the gradient on Cleint 4
The diff is 1.4619083559648982

Checking the gradient on Cleint 2
The diff is 1.2507982725832756
Checking the gradient on Cleint 3
The diff is 1.2445607723763839
Checking the gradient on Cleint 1
The diff is 1.2420636300499426

Checking the gradient on Cleint 1
The diff is 1.0934326722067418
Checking the gradient on Cleint 5
The diff is 1.0995741663361107
Checking the gradient on Cleint 4
The diff is 1.100904770958897

Run

Checking the gradient on Cleint 3
The diff is 1.988129350935044
Checking the gradient on Cleint 2
The diff is 1.9851715377007415
Checking the gradient on Cleint 1
The diff is 1.9887861520459464

Checking the gradient on Cleint 4
The diff is 1.5003493321432377
Checking the gradient on Cleint 2
The diff is 1.481846719335765
Checking the gradient on Cleint 5
The diff is 1.495635016876141

Checking the gradient on Cleint 3
The diff is 1.214024180403965
Checking the gradient on Cleint 1
The diff is 1.2186712644346658
Checking the gradient on Cleint 2
The diff is 1.2147416487922678

Checking the gradient on Cleint 3
The diff is 1.12500684093613
Checking the gradient on Cleint 1
The diff is 1.1239066155360884
Checking the gradient on Cleint 4
The diff is 1.1192412252913497

Run 

Checking the gradient on Cleint 4
The diff is 1.8559262519762498
Checking the gradient on Cleint 1
The diff is 1.8736480545754903
Checking the gradient on Cleint 3
The diff is 1.8817997154135198

Checking the gradient on Cleint 5
The diff is 1.5180617420889506
Checking the gradient on Cleint 1
The diff is 1.5223254899775454
Checking the gradient on Cleint 2
The diff is 1.5204785961657514

Checking the gradient on Cleint 3
The diff is 1.3643679567472233
Checking the gradient on Cleint 1
The diff is 1.372921837010465
Checking the gradient on Cleint 5
The diff is 1.3566168388009006

Checking the gradient on Cleint 2
The diff is 1.2149743157421489
Checking the gradient on Cleint 3
The diff is 1.206642407113206
Checking the gradient on Cleint 4
The diff is 1.2154024922464275

Run

Checking the gradient on Cleint 4
The diff is 1.9882440081753938
Checking the gradient on Cleint 5
The diff is 2.011615366394042
Checking the gradient on Cleint 1
The diff is 1.99891769530931

Checking the gradient on Cleint 2
The diff is 1.688235193886624
Checking the gradient on Cleint 4
The diff is 1.6902260057216578
Checking the gradient on Cleint 1
The diff is 1.704375783821414

Checking the gradient on Cleint 1
The diff is 1.343741979149163
Checking the gradient on Cleint 3
The diff is 1.341193552800342
Checking the gradient on Cleint 5
The diff is 1.33041067206028

ecking the gradient on Cleint 4
The diff is 1.1944627359266031
Checking the gradient on Cleint 3
The diff is 1.178809824887343
Checking the gradient on Cleint 2
The diff is 1.1868074362649494

Run

Checking the gradient on Cleint 4
The diff is 2.0160462052637
Checking the gradient on Cleint 1
The diff is 2.0609519702336287
Checking the gradient on Cleint 5
The diff is 2.0235834848710943

Checking the gradient on Cleint 2
The diff is 1.5970159507638813
Checking the gradient on Cleint 1
The diff is 1.5801770789229972
Checking the gradient on Cleint 5
The diff is 1.5900961305437236

Checking the gradient on Cleint 2
The diff is 1.2762890467696928
Checking the gradient on Cleint 1
The diff is 1.269489443886943
Checking the gradient on Cleint 5
The diff is 1.2733370297286826

Checking the gradient on Cleint 2
The diff is 1.1908792324827697
Checking the gradient on Cleint 4
The diff is 1.1860857747277274
Checking the gradient on Cleint 5
The diff is 1.18875846400814

Run

Checking the gradient on Cleint 4
The diff is 1.967220125585769
Checking the gradient on Cleint 1
The diff is 1.9664818874264989
Checking the gradient on Cleint 3
The diff is 1.9810939348102294

Checking the gradient on Cleint 4
The diff is 1.4360992558903265
Checking the gradient on Cleint 1
The diff is 1.4429706782396183
Checking the gradient on Cleint 3
The diff is 1.4341355827131228

Checking the gradient on Cleint 4
The diff is 1.2540946808549918
Checking the gradient on Cleint 5
The diff is 1.263055007381995
Checking the gradient on Cleint 1
The diff is 1.25368616864053

Checking the gradient on Cleint 5
The diff is 1.1528407193799426
Checking the gradient on Cleint 4
The diff is 1.1602679326440806
Checking the gradient on Cleint 2
The diff is 1.1499922416582005

Run

Checking the gradient on Cleint 1
The diff is 2.07940958403618
Checking the gradient on Cleint 5
The diff is 2.0749501315165904
Checking the gradient on Cleint 3
The diff is 2.0681684189282477

Checking the gradient on Cleint 3
The diff is 1.5188598334036278
Checking the gradient on Cleint 5
The diff is 1.5290719310994265
Checking the gradient on Cleint 1
The diff is 1.5191319951156195

Checking the gradient on Cleint 4
The diff is 1.18940879281639
Checking the gradient on Cleint 3
The diff is 1.194780120621306
Checking the gradient on Cleint 5
The diff is 1.181579893296313

Checking the gradient on Cleint 2
The diff is 1.0873395455850712
Checking the gradient on Cleint 1
The diff is 1.0863166593467037
Checking the gradient on Cleint 4
The diff is 1.0871766579780657


def aggregate_fit(
    self,
    server_round: int,
    results: List[Tuple[ClientProxy, FitRes]],
    failures: List[Union[Tuple[ClientProxy, FitRes], BaseException]],
) -> Tuple[Optional[Parameters], Dict[str, Scalar]]:
    """Aggregate fit results using weighted average."""
    if not results:
        return None, {}
    # Do not aggregate if there are failures and failures are not accepted
    if not self.accept_failures and failures:
        return None, {}

    # Convert results
    weights_results = [    (fit_res.parameters, fit_res.num_examples)    
                        for _, fit_res in results]
        
    print(self.threshold_list)
    
    diff_norm_list = []
    iter = 0
    upper_bound = self.threshold_list[0][server_round-1] + 3 * self.threshold_list[2][server_round-1]
    lower_bound = self.threshold_list[1][server_round-1] - 3 * self.threshold_list[2][server_round-1]
    for _, fit_res in results:
        cid = fit_res.metrics["cid"]
        
        # Check if difference between last aggregated parameter and client parameter
        # is less than a certain threshold before aggregating update
        if self.last_aggregated_parameter is not None:
            print(f"Checking the gradient on Cleint {cid}")
            client_parameter = parameters_to_ndarrays(weights_results[iter][0])
            last_parameter = parameters_to_ndarrays(self.last_aggregated_parameter)
            last_parameter = [np.array(elem) for elem in last_parameter]
            diff_norm = np.linalg.norm([np.linalg.norm(a - b) for a, b in zip(client_parameter, last_parameter)])
            print(f"The diff is {diff_norm}")
            if diff_norm >  upper_bound or diff_norm < lower_bound:
                print(f"Client {cid} parameter diff norm {diff_norm} is bigger tahn {upper_bound} or smaller than {lower_bound}. Skipping client update.")
                return self.last_aggregated_parameter, {}
            
            diff_norm_list.append(diff_norm)
            iter += 1

    # Aggregate results
    weights_aggregated = aggregate([(parameters_to_ndarrays(weights), num_examples) for weights, num_examples in weights_results])
    parameters_aggregated = ndarrays_to_parameters(weights_aggregated)

    # Save last aggregated parameter for future comparison
    self.last_aggregated_parameter = parameters_aggregated

    # Aggregate custom metrics if aggregation fn was provided
    metrics_aggregated = {}
    if self.fit_metrics_aggregation_fn:
        fit_metrics = [(res.num_examples, res.metrics) for _, res in results]
        metrics_aggregated = self.fit_metrics_aggregation_fn(fit_metrics)
    elif server_round == 1:
        log(WARNING, "No fit_metrics_aggregation_fn provided")
        
    

    return parameters_aggregated, metrics_aggregated